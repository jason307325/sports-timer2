<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- é˜²æ­¢ç¸®æ”¾ï¼Œå„ªåŒ–è¡Œå‹•ç«¯é«”é©— -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¸æ‰‹åˆ†æ®µç§’å·®è¨ˆç®—å™¨</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0071e3">

    <style>
        html, body {
            touch-action: manipulation;
            -webkit-user-select: none; /* é˜²æ­¢é•·æŒ‰é¸å–æ–‡å­— */
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f7;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 620px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,.1);
        }

        h2 { text-align: center; color: #1d1d1f; }

        .time-box {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            margin: 15px 0;
        }

        .time {
            width: 80px;
            text-align: center;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 6px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .time.active {
            border-color: #0071e3;
            background: #eef3ff;
        }

        .sep { margin: 0 6px; font-weight: bold; }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .add { background: #0071e3; color: #fff; }
        .clear-all { background: #86868b; color: #fff; }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .keypad button {
            font-size: 26px;
            padding: 18px 0;
            border: none;
            border-radius: 12px;
            background: #eef3ff;
            color: #1d1d1f;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šç°è‰²èƒŒæ™¯ */
        }

        /* æ¨¡æ“¬æŒ‰ä¸‹æ•ˆæœ */
        .keypad button:active, .actions button:active {
            opacity: 0.7;
        }

        .keypad .action { background: #0071e3; color: #fff; }
        .keypad .delete { background: #d70015; color: #fff; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th { background: #fafafa; color: #888; }

        .diff-plus { color: #d70015; }
        .diff-minus { color: #008026; }
    </style>
</head>

<body>
<div class="container">
    <h2>ğŸŠ é¸æ‰‹åˆ†æ®µç§’å·®è¨ˆç®—å™¨</h2>

    <div class="time-box">
        <div id="min" class="time">00</div>
        <span class="sep">:</span>
        <div id="sec" class="time">00</div>
        <span class="sep">.</span>
        <div id="ms" class="time">00</div>
    </div>

    <div class="actions">
        <button class="add" id="btn-add">âœ“ æ–°å¢åˆ†æ®µ</button>
        <button class="clear-all" id="btn-clear">ğŸ—‘ æ¸…é™¤å…¨éƒ¨</button>
    </div>

    <div class="keypad" id="keypad">
        <button data-val="1">1</button>
        <button data-val="2">2</button>
        <button data-val="3">3</button>
        <button data-val="4">4</button>
        <button data-val="5">5</button>
        <button data-val="6">6</button>
        <button data-val="7">7</button>
        <button data-val="8">8</button>
        <button data-val="9">9</button>
        <button class="delete" data-val="del">âŒ«</button>
        <button data-val="0">0</button>
        <button class="action" data-val="add">âœ“</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>æ®µæ¬¡</th>
                <th>ç¸½æ™‚é–“</th>
                <th>åˆ†æ®µ</th>
                <th>ç§’å·®</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<script>
// ===== æ ¸å¿ƒè®Šæ•¸ =====
const fields = ["min", "sec", "ms"];
let current = 0;
let records = [];
const tbody = document.getElementById("tbody");

// ===== 0 å»¶é²é»æ“Šè™•ç†å‡½å¼ =====
function bindFastClick(el, callback) {
    // åŒæ™‚ç›£è½ touchstart (è¡Œå‹•ç«¯) èˆ‡ click (æ¡Œæ©Ÿç«¯)
    // ä½¿ç”¨ preventDefault ç¢ºä¿ touchstart è§¸ç™¼å¾Œä¸æœƒå†è§¸ç™¼ click å°è‡´é‡è¤‡åŸ·è¡Œ
    el.addEventListener('touchstart', function(e) {
        e.preventDefault();
        callback();
    }, { passive: false });

    el.addEventListener('click', function(e) {
        // å¦‚æœæ˜¯æ”¯æ´è§¸æ§çš„è¨­å‚™ï¼Œclick æœƒè¢«ä¸Šé¢çš„ preventDefault æ“‹ä½
        // é€™è£¡ä¸»è¦æœå‹™æ¡Œæ©Ÿæ»‘é¼ ä½¿ç”¨è€…
        callback();
    });
}

// ===== åˆå§‹åŒ–åŠŸèƒ½ =====

// 1. æ™‚é–“æ¬„ä½åˆ‡æ›
fields.forEach((id, idx) => {
    const el = document.getElementById(id);
    bindFastClick(el, () => {
        current = idx;
        highlight();
    });
});

// 2. éµç›¤é‚è¼¯
document.querySelectorAll('#keypad button').forEach(btn => {
    bindFastClick(btn, () => {
        const val = btn.getAttribute('data-val');
        if (val === 'del') {
            backspace();
        } else if (val === 'add') {
            addRecord();
        } else {
            inputNum(val);
        }
    });
});

// 3. åŠŸèƒ½æŒ‰éˆ•
bindFastClick(document.getElementById('btn-add'), addRecord);
bindFastClick(document.getElementById('btn-clear'), clearAll);

// ===== é‹ç®—é‚è¼¯ =====

function highlight() {
    fields.forEach(id => document.getElementById(id).classList.remove("active"));
    document.getElementById(fields[current]).classList.add("active");
}

function inputNum(n) {
    let f = document.getElementById(fields[current]);
    if (f.textContent === "00") f.textContent = "";
    if (f.textContent.length < 2) {
        f.textContent += n;
        // è‡ªå‹•è·³ä¸‹ä¸€æ ¼
        if (f.textContent.length === 2 && current < 2) {
            current++;
            highlight();
        }
    }
}

function backspace() {
    let f = document.getElementById(fields[current]);
    if (f.textContent.length > 0 && f.textContent !== "00") {
        f.textContent = f.textContent.slice(0, -1);
        if (f.textContent === "") f.textContent = "00";
    } else if (current > 0) {
        current--;
        highlight();
    }
}

function clearTime() {
    fields.forEach(id => document.getElementById(id).textContent = "00");
    current = 0;
    highlight();
}

function timeToSec() {
    const m = parseInt(document.getElementById("min").textContent);
    const s = parseInt(document.getElementById("sec").textContent);
    const ms = parseInt(document.getElementById("ms").textContent);
    return m * 60 + s + ms / 100;
}

function secToTime(sec) {
    let m = Math.floor(sec / 60);
    let s = (sec % 60).toFixed(2);
    return `${m.toString().padStart(2, "0")}:${s.padStart(5, "0")}`;
}

function addRecord() {
    let total = timeToSec();
    if (total === 0 || records.length >= 30) return;

    let split = total;
    if (records.length > 0) {
        split = total - records[records.length - 1].total;
    }

    // æ¸¸æ³³æ¯”è³½ä¸­ï¼Œåˆ†æ®µæ™‚é–“ä¸æ‡‰ç‚ºè² å€¼ï¼ˆé™¤éè¼¸å…¥éŒ¯èª¤ï¼‰
    if (split < 0) {
        alert("ç¸½æ™‚é–“ä¸èƒ½å°‘æ–¼å‰ä¸€æ®µï¼");
        return;
    }

    records.push({ total, split });
    updateTable();
    clearTime();
}

function clearAll() {
    if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) {
        records = [];
        updateTable();
        clearTime();
    }
}

function updateTable() {
    tbody.innerHTML = "";
    records.forEach((r, i) => {
        let diff = "-", cls = "";
        if (i > 0) {
            let d = r.split - records[i - 1].split;
            diff = (d > 0 ? "+" : "") + d.toFixed(2) + "s";
            cls = d > 0 ? "diff-plus" : "diff-minus";
        }
        tbody.innerHTML += `
        <tr>
            <td>${i + 1}</td>
            <td>${secToTime(r.total)}</td>
            <td>${secToTime(r.split)}</td>
            <td class="${cls}">${diff}</td>
        </tr>`;
    });
}

// å•Ÿå‹•åˆå§‹åŒ–
highlight();

// PWA Service Worker è¨»å†Š
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
    });
}
</script>
</body>
</html>
