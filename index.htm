<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>分段記錄器 - 四鈕平衡版</title>
<style>
:root {
    --bg-dark: #0d1117; 
    --panel-dark: #161b22; 
    --text-light: #fff;
    --neon-blue: #00a2ff;
    --neon-green: #4cd964;
    --neon-red: #ff3b30;
    --neon-orange: #ff9500;
}

* { box-sizing: border-box; margin:0; padding:0; touch-action: manipulation; }
html, body { height: 100dvh; width:100%; background: var(--bg-dark); color: var(--text-light); font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
button { cursor: pointer; border: none; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
button:active { transform: scale(0.95); }

.app-container { display:flex; flex-direction:column; height:100%; width:100%; max-width:800px; margin:0 auto; }

header { display:flex; background:#05070a; border-bottom:2px solid #1a2028; flex-shrink:0; }
header div.tab-btn { flex:1; text-align:center; padding:15px 0; font-size:14px; font-weight:900; color:#666; border-bottom:3px solid transparent; transition: all 0.3s ease; }
header div.tab-btn.active { color: var(--neon-blue); border-bottom-color: var(--neon-blue); background: rgba(0,162,255,0.05); }

.content-wrapper { flex:1; display:flex; position:relative; overflow:hidden; }
.page { position:absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction:column; }
.page.active { display:flex; }

.table-container { flex:1; overflow-y:auto; padding:10px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
table { width:100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { padding:10px 5px; text-align:center; font-size:13px; border-bottom:1px solid #222; }
th { position:sticky; top:0; background:var(--panel-dark); color:#888; z-index:5; }

.control-panel { flex-shrink:0; padding:15px; background: var(--panel-dark); border-top:1px solid #1a2028; display:flex; flex-direction:column; gap:12px; }

/* 優化：放大時間輸入格子 */
.time-box { 
    display:flex; 
    justify-content:center; 
    align-items:center; 
    gap:6px; 
    margin-bottom: 5px;
    height: 80px; /* 增加高度釋放空間 */
}
.time-input { 
    width:80px; 
    height:60px; 
    line-height:60px; 
    text-align:center; 
    border:2px solid #333; 
    border-radius:12px; 
    background:#090c10; 
    font-size:32px; 
    font-weight:700; 
    color:#fff; 
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.time-input.active { 
    border-color: var(--neon-blue); 
    background: rgba(0,162,255,0.1);
    box-shadow: 0 0 20px rgba(0,162,255,0.4);
}
.time-box span { 
    font-size: 28px; 
    font-weight: 700; 
    color: #666; 
}

/* 優化：放大數字鍵盤 */
.keypad { 
    display:grid; 
    grid-template-columns:repeat(3,1fr); 
    gap:10px;
    margin-top: 15px; /* 增加鍵盤上方的間距 */
}
.keypad button { 
    padding:18px; 
    border-radius:12px; 
    font-size:24px; 
    font-weight:700; 
    background:#1c222d; 
    color:#fff; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.keypad button:active { 
    background:#252d3a; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.4) inset;
}
.keypad .k-del { background: #2d1f1f; color: var(--neon-red); }
.keypad .k-del:active { background: #3d2525; }
.keypad .k-ok { background: var(--neon-blue); }
.keypad .k-ok:active { background: #0090e0; }

.sw-view { text-align:center; padding:10px 0; }
#swDisplay { 
    font-family:"Courier New", monospace; 
    font-size: clamp(3.2rem,12vw,4.5rem); 
    font-weight:800; 
    font-variant-numeric: tabular-nums; 
    letter-spacing:-2px; 
}

.sw-actions { display:grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap:10px; }
.sw-actions button { 
    padding:18px 0; 
    border-radius:12px; 
    font-size:18px; 
    font-weight:700; 
    color:#fff; 
    width: 100%; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.btn-start { background: var(--neon-green); }
.btn-start:active { background: #3db84d; }
.btn-lap { background: var(--neon-blue); }
.btn-lap:active { background: #0090e0; }
.btn-pause { background: var(--neon-orange); }
.btn-pause:active { background: #e08600; }
.btn-stop { background: var(--neon-red); }
.btn-stop:active { background: #e03020; }
.btn-lock { opacity: 0.15; pointer-events: none; filter: grayscale(1); }

.btn-del-row { 
    width:26px; 
    height:26px; 
    border-radius:50%; 
    background:#2d1f1f; 
    color: var(--neon-red); 
    font-weight:bold; 
    font-size: 16px;
}
.btn-del-row:active { background: #3d2525; }

.btn-clear-footer { 
    width:100%; 
    padding:15px; 
    background:transparent; 
    color:#555; 
    font-size:12px; 
    border-top: 1px dashed #333; 
    margin-top: 10px; 
}
.btn-clear-footer:active { color: var(--neon-red); }

.diff-up { color: var(--neon-red); }
.diff-down { color: var(--neon-green); }

/* 優化：加入載入提示 */
.loading-hint {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,162,255,0.9);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 1000;
}
.loading-hint.show { opacity: 1; }

@media (min-width:768px){ 
    .content-wrapper{flex-direction:row;} 
    .table-container{flex:1.2;} 
    .control-panel{flex:0.8;} 
}
</style>
</head>
<body>
<div class="app-container">
    <header>
        <div id="tabManual" class="tab-btn active" onclick="switchTab('manual')">手動輸入</div>
        <div id="tabSW" class="tab-btn" onclick="switchTab('sw')">碼錶計時</div>
    </header>

    <main class="content-wrapper">
        <div id="page-manual" class="page active">
            <div class="table-container" id="manualScrollArea">
                <table>
                    <thead>
                        <tr><th>段</th><th>總時間</th><th>分段</th><th>秒差</th><th></th></tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
                <button id="btnManualClear" class="btn-clear-footer">✕ 清空所有手動紀錄</button>
            </div>
            <div class="control-panel">
                <div class="time-box">
                    <div id="m_min" class="time-input active">00</div><span>:</span>
                    <div id="m_sec" class="time-input">00</div><span>.</span>
                    <div id="m_ms" class="time-input">00</div>
                </div>
                <div class="keypad">
                    <button class="k-num">7</button><button class="k-num">8</button><button class="k-num">9</button>
                    <button class="k-num">4</button><button class="k-num">5</button><button class="k-num">6</button>
                    <button class="k-num">1</button><button class="k-num">2</button><button class="k-num">3</button>
                    <button class="k-del" id="keyDel">⌫</button><button class="k-num">0</button><button class="k-ok" id="keySave">✓</button>
                </div>
            </div>
        </div>

        <div id="page-sw" class="page">
            <div class="table-container" id="swScrollArea">
                <table>
                    <thead>
                        <tr><th>段</th><th>總時間</th><th>分段</th><th>秒差</th><th></th></tr>
                    </thead>
                    <tbody id="tbodySW"></tbody>
                </table>
                <button id="btnSWClear" class="btn-clear-footer">✕ 重置碼錶並清空紀錄</button>
            </div>
            <div class="control-panel">
                <div class="sw-view"><div id="swDisplay">00:00.00</div></div>
                <div class="sw-actions">
                    <button id="swStart" class="btn-start">開始</button>
                    <button id="swLap" class="btn-lap btn-lock">分段</button>
                    <button id="swPause" class="btn-pause btn-lock">暫停</button>
                    <button id="swStop" class="btn-stop btn-lock">結束</button>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="loadingHint" class="loading-hint">處理中...</div>

<script>
let manualData=[], swData=[];
let fields=["m_min","m_sec","m_ms"], fieldIdx=0, inputCount=0;
let timerState="idling", startT=0, elapsedT=0, raf=null;

function switchTab(tab){
    document.getElementById("tabManual").classList.toggle("active", tab==="manual");
    document.getElementById("tabSW").classList.toggle("active", tab==="sw");
    document.getElementById("page-manual").classList.toggle("active", tab==="manual");
    document.getElementById("page-sw").classList.toggle("active", tab==="sw");
    tab === "manual" ? render() : renderSW();
}

/* 手動輸入 - 修復: 防止輸入無效值 */
fields.forEach((id,i)=>{
    const el = document.getElementById(id);
    el.onclick = () => {
        fieldIdx = i;
        inputCount = 0;
        updateFocus();
    };
    
    // 防止非數字輸入
    el.addEventListener('input', (e) => {
        let value = e.target.innerText.replace(/\D/g, '');
        if (value.length > 2) value = value.slice(0, 2);
        e.target.innerText = value.padStart(2, '0');
    });
});

function updateFocus(){
    fields.forEach((id,i)=>{
        const el = document.getElementById(id);
        el.classList.toggle("active", i===fieldIdx);
    });
}

document.querySelectorAll(".k-num").forEach(b=>{
    b.onclick = ()=>{
        const currentField = document.getElementById(fields[fieldIdx]);
        const currentValue = currentField.innerText;
        
        if(inputCount === 0){
            // 第一鍵輸入
            currentField.innerText = "0" + b.innerText;
            inputCount = 1;
        } else {
            // 第二鍵輸入，替換第二個數字
            currentField.innerText = currentValue.charAt(1) + b.innerText;
            inputCount = 0;
            
            // 自動跳到下一個欄位
            if(fieldIdx < fields.length - 1){
                fieldIdx++;
                updateFocus();
            }
        }
    };
});

document.getElementById("keyDel").onclick = ()=>{
    const currentField = document.getElementById(fields[fieldIdx]);
    currentField.innerText = "00";
    inputCount = 0;
    if(fieldIdx > 0){
        fieldIdx--;
        updateFocus();
    }
};

document.getElementById("keySave").onclick = ()=>{
    // 獲取並格式化輸入值
    const min = parseInt(document.getElementById("m_min").innerText) || 0;
    const sec = parseInt(document.getElementById("m_sec").innerText) || 0;
    const ms = parseInt(document.getElementById("m_ms").innerText) || 0;
    
    // 計算總時間（秒）
    const total = min * 60 + sec + ms / 100;
    
    if(total <= 0){
        alert("請輸入有效的時間！");
        return;
    }
    
    // 添加到數據
    manualData.push({
        id: Date.now() + Math.random(),
        total: total
    });
    
    // 排序
    manualData.sort((a,b)=> a.total - b.total);
    
    // 重置輸入框
    fields.forEach(id => {
        document.getElementById(id).innerText = "00";
    });
    fieldIdx = 0;
    inputCount = 0;
    updateFocus();
    
    // 渲染和滾動
    render();
    scrollToBottom("manualScrollArea");
};

document.getElementById("btnManualClear").onclick = ()=>{ 
    if(manualData.length > 0 && confirm("確定刪除所有手動紀錄？")){ 
        manualData = []; 
        render(); 
    } 
};

/* 碼錶邏輯 - 修復: 修正暫停/繼續狀態切換 */
function tick(){
    elapsedT = (performance.now() - startT) / 1000;
    let m = Math.floor(elapsedT / 60);
    let ss = (elapsedT % 60).toFixed(2).padStart(5, "0");
    document.getElementById("swDisplay").innerText = `${String(m).padStart(2, "0")}:${ss}`;
    if(timerState === "running"){
        raf = requestAnimationFrame(tick);
    }
}

const sBtn = document.getElementById("swStart");
const lBtn = document.getElementById("swLap");
const pBtn = document.getElementById("swPause");
const tBtn = document.getElementById("swStop");

sBtn.onclick = ()=>{
    if(timerState === "stopped") return;
    
    if(timerState === "idling" || timerState === "stopped"){
        // 第一次開始或重新開始
        timerState = "running";
        startT = performance.now() - (elapsedT * 1000);
        tick();
    }
    updateSwBtnState();
};

pBtn.onclick = ()=>{
    if(timerState === "running"){
        // 暫停
        timerState = "paused";
        cancelAnimationFrame(raf);
        pBtn.innerText = "繼續";
    } else if(timerState === "paused"){
        // 繼續
        timerState = "running";
        startT = performance.now() - (elapsedT * 1000);
        tick();
        pBtn.innerText = "暫停";
    }
    updateSwBtnState();
};

lBtn.onclick = ()=>{
    if(elapsedT > 0 && timerState === "running"){ 
        swData.push({
            id: Date.now() + Math.random(), 
            total: elapsedT
        }); 
        renderSW(); 
        scrollToBottom("swScrollArea"); 
    }
};

tBtn.onclick = ()=>{
    if(timerState === "idling") return;
    
    cancelAnimationFrame(raf);
    timerState = "stopped";
    
    // 只有當有時間時才記錄最後一段
    if(elapsedT > 0){
        swData.push({
            id: Date.now() + Math.random(), 
            total: elapsedT
        });
        renderSW();
        scrollToBottom("swScrollArea");
    }
    
    updateSwBtnState();
};

function updateSwBtnState(){
    const isRunning = timerState === "running";
    const isPaused = timerState === "paused";
    const isStopped = timerState === "stopped";
    const isIdling = timerState === "idling";

    sBtn.classList.toggle("btn-lock", isRunning || isPaused || isStopped);
    pBtn.classList.toggle("btn-lock", isIdling || isStopped);
    lBtn.classList.toggle("btn-lock", isIdling || isStopped || isPaused);
    tBtn.classList.toggle("btn-lock", isIdling);
    
    if(isIdling || isStopped){
        pBtn.innerText = "暫停";
    }
}

document.getElementById("btnSWClear").onclick = ()=>{
    if(swData.length > 0 && confirm("確定重置碼錶並清空所有紀錄？")){
        cancelAnimationFrame(raf);
        timerState = "idling";
        elapsedT = 0;
        swData = [];
        document.getElementById("swDisplay").innerText = "00:00.00";
        pBtn.innerText = "暫停";
        renderSW();
        updateSwBtnState();
    }
};

/* 渲染通用 */
function renderCore(data, bodyId, deleteFnName){
    const body = document.getElementById(bodyId);
    
    if(data.length === 0) {
        body.innerHTML = `<tr><td colspan="5" style="padding:40px;color:#444;">無紀錄</td></tr>`;
        return;
    }
    
    const rows = data.map((item, i) => {
        const prevT = i > 0 ? data[i-1].total : 0;
        const lap = item.total - prevT;
        let dStr = "-";
        let dCls = "";
        
        if(i > 0){
            const pLap = (i === 1) ? data[0].total : data[i-1].total - data[i-2].total;
            const diff = lap - pLap;
            dStr = (diff > 0 ? "+" : "") + diff.toFixed(2);
            dCls = diff > 0 ? "diff-up" : "diff-down";
        }
        
        return `<tr>
            <td>${i+1}</td>
            <td style="color:var(--neon-blue);font-weight:700;">${fmt(item.total)}</td>
            <td>${fmt(lap)}</td>
            <td class="${dCls}">${dStr}</td>
            <td><button class="btn-del-row" onclick="${deleteFnName}(${item.id})">−</button></td>
        </tr>`;
    }).join('');
    
    body.innerHTML = rows;
}

function render(){ 
    renderCore(manualData, "tbody", "delM"); 
}

function renderSW(){ 
    renderCore(swData, "tbodySW", "delS"); 
}

function delM(id){ 
    manualData = manualData.filter(x => x.id !== id); 
    render(); 
}

function delS(id){ 
    swData = swData.filter(x => x.id !== id); 
    renderSW(); 
}

function fmt(s){ 
    const m = Math.floor(s/60);
    const ss = (s%60).toFixed(2).padStart(5,"0"); 
    return `${String(m).padStart(2,"0")}:${ss}`; 
}

function scrollToBottom(id){ 
    const el = document.getElementById(id); 
    setTimeout(() => {
        el.scrollTop = el.scrollHeight;
    }, 50); 
}

// 初始化渲染
render();
renderSW();
updateSwBtnState();
</script>
</body>
</html>
